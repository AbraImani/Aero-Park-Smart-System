<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin AeroPark GOMA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-plane"></i>
                <span>AeroPark GOMA</span>
            </div>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li class="active">
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li>
                    <a href="places.html">
                        <i class="fas fa-parking"></i>
                        <span>Gestion des places</span>
                    </a>
                </li>
                <li>
                    <a href="reservations.html">
                        <i class="fas fa-calendar-check"></i>
                        <span>Réservations</span>
                    </a>
                </li>
                <li>
                    <a href="users.html">
                        <i class="fas fa-users"></i>
                        <span>Utilisateurs</span>
                    </a>
                </li>
                <li>
                    <a href="payments.html">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Paiements</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <div class="admin-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-details">
                    <span class="admin-name" id="admin-name">Admin</span>
                    <span class="admin-role">Administrateur</span>
                </div>
            </div>
            <button class="btn-logout" id="admin-logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Tableau de bord</h1>
            </div>
            <div class="header-right">
                <span class="current-date" id="current-date"></span>
            </div>
        </header>

        <div class="admin-content">
            <!-- Stats Cards -->
            <section class="dashboard-stats">
                <div class="stat-card-admin">
                    <div class="stat-card-icon blue">
                        <i class="fas fa-parking"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-total-places">0</h3>
                        <p>Places totales</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-available">0</h3>
                        <p>Disponibles</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-reserved">0</h3>
                        <p>Réservées</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon red">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-occupied">0</h3>
                        <p>Occupées</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon purple">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-users">0</h3>
                        <p>Utilisateurs</p>
                    </div>
                </div>

                <div class="stat-card-admin">
                    <div class="stat-card-icon teal">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-card-info">
                        <h3 id="stat-revenue">0 FC</h3>
                        <p>Revenus totaux</p>
                    </div>
                </div>
            </section>

            <!-- Charts & Tables Row -->
            <div class="dashboard-grid">
                <!-- Occupation Chart -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i> Taux d'occupation</h3>
                    </div>
                    <div class="card-body">
                        <div class="occupation-chart">
                            <div class="chart-ring">
                                <svg viewBox="0 0 200 200">
                                    <circle class="chart-bg" cx="100" cy="100" r="80"></circle>
                                    <circle class="chart-progress" cx="100" cy="100" r="80" id="occupation-ring"></circle>
                                </svg>
                                <div class="chart-center">
                                    <span id="occupation-percent">0%</span>
                                </div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <span class="dot green"></span>
                                    <span>Disponibles: <strong id="legend-available">0</strong></span>
                                </div>
                                <div class="legend-item">
                                    <span class="dot orange"></span>
                                    <span>Réservées: <strong id="legend-reserved">0</strong></span>
                                </div>
                                <div class="legend-item">
                                    <span class="dot red"></span>
                                    <span>Occupées: <strong id="legend-occupied">0</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Reservations -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-check"></i> Réservations récentes</h3>
                        <a href="reservations.html" class="card-link">Voir tout</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Place</th>
                                        <th>Utilisateur</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-reservations">
                                    <tr>
                                        <td colspan="4" class="text-center">Chargement...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Payments -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-money-bill-wave"></i> Derniers paiements</h3>
                    <a href="payments.html" class="card-link">Voir tout</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Place</th>
                                    <th>Montant</th>
                                    <th>Méthode</th>
                                    <th>Téléphone</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="recent-payments">
                                <tr>
                                    <td colspan="7" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parking Map Overview -->
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3><i class="fas fa-map"></i> Aperçu du parking</h3>
                    <a href="places.html" class="card-link">Gérer les places</a>
                </div>
                <div class="card-body">
                    <div class="parking-overview" id="parking-overview">
                        <!-- Généré par JavaScript -->
                    </div>
                    <div class="map-legend" style="margin-top: 1rem;">
                        <div class="legend-item">
                            <span class="legend-color available"></span>
                            <span>Disponible</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color occupied"></span>
                            <span>Occupée</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color reserved"></span>
                            <span>Réservée</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/data.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        // Vérifier l'authentification
        if (!AdminAuth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            initSidebar();
            updateCurrentDate();
        });

        function initDashboard() {
            loadStats();
            loadOccupationChart();
            loadRecentReservations();
            loadRecentPayments();
            loadParkingOverview();

            // Mettre à jour le nom admin
            const admin = AdminAuth.getCurrentAdmin();
            if (admin) {
                document.getElementById('admin-name').textContent = admin.username;
            }
        }

        function updateCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        function loadStats() {
            const parkingStats = ParkingData.getStats();
            const users = JSON.parse(localStorage.getItem('aeropark_users') || '[]');
            const payments = JSON.parse(localStorage.getItem('aeropark_payments') || '[]');
            
            // Calculer les revenus
            const totalRevenue = payments.reduce((sum, p) => sum + (p.amount || 0), 0);

            document.getElementById('stat-total-places').textContent = parkingStats.total;
            document.getElementById('stat-available').textContent = parkingStats.available;
            document.getElementById('stat-reserved').textContent = parkingStats.reserved;
            document.getElementById('stat-occupied').textContent = parkingStats.occupied;
            document.getElementById('stat-users').textContent = users.length;
            document.getElementById('stat-revenue').textContent = totalRevenue.toLocaleString('fr-FR') + ' FC';
        }

        function loadOccupationChart() {
            const stats = ParkingData.getStats();
            const occupationRate = stats.occupationRate;
            
            const ring = document.getElementById('occupation-ring');
            const circumference = 2 * Math.PI * 80;
            const offset = circumference - (occupationRate / 100) * circumference;
            
            ring.style.strokeDasharray = circumference;
            ring.style.strokeDashoffset = offset;

            document.getElementById('occupation-percent').textContent = occupationRate + '%';
            document.getElementById('legend-available').textContent = stats.available;
            document.getElementById('legend-reserved').textContent = stats.reserved;
            document.getElementById('legend-occupied').textContent = stats.occupied;
        }

        function loadRecentReservations() {
            const reservations = ParkingData.getReservations();
            const users = JSON.parse(localStorage.getItem('aeropark_users') || '[]');
            const tbody = document.getElementById('recent-reservations');

            // Prendre les 5 dernières
            const recent = reservations.slice(-5).reverse();

            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune réservation</td></tr>';
                return;
            }

            tbody.innerHTML = recent.map(res => {
                const user = users.find(u => u.id === res.userId) || { name: 'Inconnu' };
                const date = new Date(res.createdAt).toLocaleDateString('fr-FR');
                const statusClass = res.status === 'active' ? 'success' : 'secondary';
                const statusText = res.status === 'active' ? 'Active' : 'Terminée';
                
                return `
                    <tr>
                        <td><strong>${res.spotId}</strong></td>
                        <td>${user.name}</td>
                        <td>${date}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function loadRecentPayments() {
            const payments = JSON.parse(localStorage.getItem('aeropark_payments') || '[]');
            const tbody = document.getElementById('recent-payments');

            // Prendre les 5 derniers
            const recent = payments.slice(-5).reverse();

            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucun paiement</td></tr>';
                return;
            }

            const methodNames = {
                'orange': 'Orange Money',
                'airtel': 'Airtel Money',
                'mpesa': 'M-Pesa'
            };

            tbody.innerHTML = recent.map(pay => {
                const date = new Date(pay.paidAt).toLocaleDateString('fr-FR');
                const statusClass = pay.status === 'completed' ? 'success' : 'danger';
                const statusText = pay.status === 'completed' ? 'Réussi' : 'Échoué';
                
                return `
                    <tr>
                        <td>#${pay.id.slice(-6)}</td>
                        <td><strong>${pay.spotId}</strong></td>
                        <td>${pay.amount.toLocaleString('fr-FR')} FC</td>
                        <td>${methodNames[pay.paymentMethod] || pay.paymentMethod}</td>
                        <td>${pay.phoneNumber}</td>
                        <td>${date}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function loadParkingOverview() {
            const container = document.getElementById('parking-overview');
            const spots = ParkingData.getAllSpots();

            container.innerHTML = spots.map(spot => `
                <div class="parking-spot-admin ${spot.status}" title="Place ${spot.id} - ${spot.status}">
                    ${spot.id}
                </div>
            `).join('');
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileToggle = document.getElementById('mobile-menu-toggle');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
            });

            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
            });

            // Déconnexion
            document.getElementById('admin-logout').addEventListener('click', () => {
                AdminAuth.logout();
                window.location.href = 'login.html';
            });
        }

        // Rafraîchir les données toutes les 10 secondes
        setInterval(() => {
            loadStats();
            loadOccupationChart();
            loadParkingOverview();
        }, 10000);
    </script>
</body>
</html>
